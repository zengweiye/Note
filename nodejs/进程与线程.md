## 进程与线程

### 进程

进程是计算机中的程序关于某数据集合上的一次运行活动，是系统进行资源分配和调度的基本单位，操作系统结构的基础，同时也是线程的容器。

每开启一次服务，每执行一个实例，都是开启一个服务进程



### 线程

线程是操作系统能够进行运算调度的最小单位，线程位于进程之内，每一个线程只隶属一个进程，一个进程能有多个线程。

同一进程中的多个线程将共享该进程中的全部系统资源，但线程都有各自的调用栈，寄存器环境，本地的存储。



### 单线程与异步调用

`Nodejs`虽然是单线程模型，但是基于时间驱动，异步非阻塞模式，可以应用于高并发场景，避免了线程创建，线程之间上下文切换所产生的资源开销。

其中非阻塞模式基于事件循环。



### `nodejs`的进程与线程

`nodejs`基于时间驱动，非阻塞`I/O`模型，充分利用操作系统提供的异步`I/O`进行多任务的执行，适合用于`I/O`密集型场景。

在单核CPU上可以使用`单进程多线程`，在多核CPU中通过`fork`开启多个进程，使用`多进程单线程`。从而解决CPU利用率问题。



### `Nodejs`进程创建

1. `child_process.spawn()`：适用于返回大量数据，例如图像处理，二进制数据处理。

2. `child_process.exec()`：适用于小量数据，`maxBuffer` 默认值为 200 * 1024 超出这个默认值将会导致程序崩溃，数据量过大可采用 spawn。

3. `child_process.execFile()`：类似 `child_process.exec()`，区别是不能通过 shell 来执行，不支持像 I/O 重定向和文件查找这样的行为

4. `child_process.fork()`： 衍生新的进程，进程之间是相互独立的，每个进程都有自己的 V8 实例、内存，系统资源是有限的，不建议衍生太多的子进程出来，通长根据系统 CPU 核心数设置。



### 父子进程之间通信

1. 父子进程之间的`stdio`建立管道链接

   ```
   child.stdout.pipe(process.stdout);
   ```

2. 父子进程共用同一个`stdio`

3. 事件监听



### 多进程框架

#### 主进程

1. 创建一个`server`并监听端口
2. 根据`cpus`开启多个子进程
3. 通过子进程对象的`send`方法发送到子进程进行通信。
4. 在主进程监听子进程的变化，如果子进程产生自杀信号则重新启动一个工作进程。
5. 监听到退出信号时，先推出子进程再退出主进程。



#### 子进程

1. 创建`server`对象
2. 通过`message`事件接受主进程`send`方法的消息
3. 监听`uncaughtException`事件，捕获未处理的异常。发送自杀信息有主进程进行重建。



### 守护进程

守护进程运行在后台不受终端的影响。也就是说在终端开启一个服务后，还能在这个终端做别的事。

**步骤**

1. 创建子进程

   使用`spawn`创建子进程

2. 在子进程创建会话（调用系统函数`setsid`）

   设置`options.detached=true`使得子进程在父进程退出后仍继续运行

3. 改变子进程工作目录

   通过`options.cwd`指定当前子进程工作目录

4. 父进程终结

   运行`daremon.unref`退出父进程



### 孤儿进程

父进程创建子进程后，父进程退出，剩下的子进程会被系统`init`进程收养，`ppid`为1



### 多进程中为什么不会产生监听端口冲突

通过句柄传递。

当父子进程建立`IPC`通道后，通过子进程对象的`send`方法发送消息，第二个参数`sendHandle`就是句柄。通过句柄，将主进程的`socket`传递到子进程，而避免端口冲突



### `IPC`（进程间通信技术)

由于每个进程创建之后都会有自己的独立地址空间，实现`IPC`的目的就是进程之间共享资源，共享访问

`Nodejs`通过`pipe`管道进行实现`IPC`

**创建方法**

创建一个父进程和子进程之间传递消息的` IPC `通道实现输出信息

```javascript
const spawn = require('child_process').spawn;
const child = spawn('node', ['worker.js'])
child.stdout.pipe(process.stdout);
console.log(process.pid, child.pid);
```

#### 父子进程的通信原理

父进程在建立`IPC`通道并一直监听，之后创建子进程时通过环境变量的方式将`IPC`通道的文件描述符传递到子进程，子进程启动时根据传递的文件描述符去链接`IPC`通道，从而建立父子进程之间的通信。



### 多进程或多个 Web 服务之间的状态共享问题

多进程模式下各个进程是相互独立的，进程之间无法获取其他状态，通常使用`redis`和数据库保存